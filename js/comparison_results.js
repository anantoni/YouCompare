/*****************************************************************************\
|   Author  : Zorbas Dimitrios  1115 2007 00078                             **|
|   contact : zorbash@hotmail.com                                           **|
|   Project: YouCompare Site - Software Engineering Course Spring 2011      **|
|   Description: Gui Part for page comparison results  (javascript)         **|
|                                                                           **|   
\*****************************************************************************/

google.load('visualization','1',{packages:['table','corechart','charteditor']});google.setOnLoadCallback(drawVisualizations);var mainDataset;var totalScoresDataview;var total_scores_wrapper;var attribute_scores_wrapper
var tabular_visualization;var editor_wrapper;var totalScoresDataset;var attributeScoresDataset;var rankings;function drawVisualizations(){mainDataset=new google.visualization.DataTable();mainDataset=populate_mainDataset();totalScoresDataset=mainDataset.clone();attributeScoresDataset=mainDataset.clone();rankings=new render_rankings(mainDataset.clone());rankings.generate_rankings();rankings.render_rankings_div("rankings-content");render_total_scores(totalScoresDataset);render_attribute_scores_init(attributeScoresDataset);render_tabular_scores(mainDataset.clone());}
function populate_mainDataset(){var data=new google.visualization.DataTable();data.addColumn('string','Entity name');data.addColumn('number',"Total score");for(var attribute_index in scores.attribute_name){data.addColumn('number',scores.attribute_name[attribute_index].name);}
data.addRows(scores.entities.count);var index=0;for(var entity_index in scores.entities){data.setValue(index++,0,scores.entities[entity_index].entity_name);if(index==scores.entities.count)break;}
index=0;for(var total_score_index in scores.entity_total_score){data.setCell(index,1,parseFloat(scores.entity_total_score[total_score_index].toFixed(2)));index++}
index=0;for(var ent_key in scores.attribute_score){for(var attr_key in scores.attribute_score[ent_key]){data.setCell(index,parseInt(attr_key)+2,parseFloat(scores.attribute_score[ent_key][attr_key].toFixed(2)));}
index++;}
return data;}
function getParams(){var map={};var parts=window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(m,key,value){map[key]=value;});return map;}
function render_rankings(dataset){var self=this;this.parameters={};this.dataview;this.rankingsObj={};this.parameters.cat_id=getParams()['cat_id'];this.parameters.comparison_type=getParams()['comparison_type'];this.dataview=new google.visualization.DataView(dataset);this.generate_rankings=function generate_rankings(){for(var entities_index in scores.entities){self.rankingsObj[entities_index]={};}
for(var j=1;j<self.dataview.getNumberOfColumns();j++){self.dataview=new google.visualization.DataView(dataset);self.dataview.setRows(self.dataview.getSortedRows([{column:j,desc:true}]));var columnLabel=self.dataview.getColumnLabel(j);var attr_index;if(j!=1){console.info("here");for(var attribute_index in scores.attribute_name){if(scores.attribute_name[attribute_index].name==columnLabel){attr_index=attribute_index;break;}}}
else{attr_index="total_score";}
for(var i=0;i<self.dataview.getNumberOfRows();i++){for(var entities_index in scores.entities){if(self.dataview.getValue(i,0)==scores.entities[entities_index].entity_name){self.rankingsObj[entities_index][attr_index]=i+1;}}}}
/*console.log(self.rankingsObj);*/}
this.getData=function getData(){return self.rankingsObj;}
this.render_rankings_div=function render_rankings_div(container){var content="";content+="<p>The best entitites for each attribute are the following</p>";content+="<table class=\"rankings-table\">";for(ent_index in self.rankingsObj){if(self.rankingsObj[ent_index]["total_score"]==1){content+="<tr>";content+="<td><span>"+"Total score"+"</span></td><td><a name =\""+ent_index+"\" href=\""+"browseEntity.php?cat_id="+self.parameters.cat_id+"&ent_id="+ent_index+"\"><span> : "+scores.entities[ent_index].entity_name+"</span></a></td>";content+="</tr>";break;}}
for(var attr_index in scores.attribute_name){for(ent_index in self.rankingsObj){if(self.rankingsObj[ent_index][attr_index]==1){content+="<tr>";content+="<td><span>"+scores.attribute_name[attr_index].name+"</span></td><td><a name =\""+ent_index+"\" href=\""+"browseEntity.php?cat_id="+self.parameters.cat_id+"&ent_id="+ent_index+"\"><span> : "+scores.entities[ent_index].entity_name+"</span></a></td>";content+="</tr>";break;}}}
content+="</table>";$("div#rankings-content").html(content);}}
function entity_select_handler(e){/*console.log(e);*/var selection=total_scores_wrapper.getSelection();var dataset_entity_name=totalScoresDataset.F[selection[0].row].c[0].v;var id;for(var index in scores.entities){if(scores.entities[index].entity_name==dataset_entity_name){id=index;break;}}
render_entity_info(id);}
function render_total_scores(data){var adjustableHeight=scores.entities.count*40;if(adjustableHeight>1200)adjustableHeight=1200;else if(adjustableHeight<600)adjustableHeight=600;totalScoresDataset.sort([{column:1,desc:true}]);var totalScoresDataview=new google.visualization.DataView(totalScoresDataset);totalScoresDataview.setColumns([0,1]);total_scores_wrapper=new google.visualization.BarChart(document.getElementById('google-total-scores'));total_scores_wrapper.draw(totalScoresDataview,{'title':'Total scores','width':'800','height':adjustableHeight,'is3d':'true','colors':['#FF0000','#FFFF00','#00FF00'],'backgroundColor':'transparent','backgroundColor.stroke':'white','hAxis':{"title":"Total score for entities"},'vAxis':{"title":"Entities"},'chartArea.left':'10','chartArea.top':'10'});google.visualization.events.addListener(total_scores_wrapper,'select',entity_select_handler);}
function render_tabular_scores(data){tabular_visualization=new google.visualization.Table(document.getElementById('google-tabular-scores'));var options={};options['page']='enable';options['pageSize']=$("select.tabular-max-per-page").val();options['pagingSymbols']={prev:'prev',next:'next'};options['pagingButtonsConfiguration']='auto';options['showRowNumber']=true;options['sortAscending']=false;options['sortColumn']=1;options['alternatingRowStyle']=true;tabular_visualization.draw(data,options);}
function render_attribute_scores(data){var adjustableHeight=scores.entities.count*40;if(adjustableHeight>1200)adjustableHeight=1200;else if(adjustableHeight<600)adjustableHeight=600;attribute_scores_wrapper=new google.visualization.ChartWrapper({chartType:'BarChart',dataTable:data,options:{'title':data.getColumnLabel(1)+' by entity','width':'800','height':adjustableHeight,'is3d':'true','backgroundColor':'transparent','backgroundColor.stroke':'white','hAxis':{"title":"Score"},'vAxis':{"title":"Entity"},'chartArea.left':'10','chartArea.top':'10'},containerId:'google-attribute-scores'});attribute_scores_wrapper.draw();}
function render_attribute_scores_init(data){var adjustableHeight=scores.entities.count*40;if(adjustableHeight>1200)adjustableHeight=1200;else if(adjustableHeight<600)adjustableHeight=600;attributeScoresDataset.sort([{column:2,desc:true}]);var initDataview=new google.visualization.DataView(attributeScoresDataset);initDataview.setColumns([0,2]);attribute_scores_wrapper=new google.visualization.ChartWrapper({chartType:'BarChart',dataTable:initDataview,options:{'title':attributeScoresDataset.getColumnLabel(2)+' by entity','width':'800','height':adjustableHeight,'is3d':'true','backgroundColor':'transparent','backgroundColor.stroke':'white','hAxis':{"title":"Score"},'vAxis':{"title":"Entity"},'chartArea.left':'10','chartArea.top':'10'},containerId:'google-attribute-scores'});attribute_scores_wrapper.draw();google.visualization.events.addListener(attribute_scores_wrapper,'select',entity_select_handler);}
function render_entity_info(id){var ent_index=id;var content="";content+="<span class=\"close\"></span>";content+="<h1>"+scores.entities[ent_index].entity_name+"</h1>";if(scores.entities[ent_index].entity_image!=null){content+="<img src=\""+scores.entities[ent_index].entity_image+"\">";}
else{content+="<img src=\""+"./cat_images/__not__.jpg"+"\">";}
if(scores.entities[ent_index].entity_video!=null&&scores.entities[ent_index].entity_video!=" "){content+="<a href=\""+scores.entities[ent_index].entity_video+"\">video</a>";}
content+="<table class=\"attribute-info\">";content+="<th>Attr.Name</th><th>Value</th><th>Rank</th>";for(var ent_attr_index in scores.entities[ent_index].entity_attribute_values){if(scores.attribute_name[ent_attr_index]!==undefined){content+="<tr>";if(scores.entities[ent_index].entity_attribute_values[ent_attr_index]!=null){content+="<td><span>"+scores.attribute_name[ent_attr_index].name+" : </span></td><td><span>"+scores.entities[ent_index].entity_attribute_values[ent_attr_index]+"</span></td>";content+="<td><span>"+rankings.getData()[ent_index][ent_attr_index]+"</span></td>";}
else{content+="<td><span>"+scores.attribute_name[ent_attr_index].name+" : </span></td><td><span>"+"not set"+"</span></td>";}
content+="</tr>";}}
content+="</table>";$("div.entity-info-wrapper").html(content);$("div.entity-info-wrapper").show();}
function drawAttributeScores(){var data=new google.visualization.DataTable();for(var i=0;i<cmp_entity_names.length;++i){data.addColumn('number',cmp_entity_names[i]);}
for(var j=0;j<cmp_attribute_names.length;j++){data.addRow(cmp_attribute_scores[j]);}
var wrapper=new google.visualization.ChartWrapper({chartType:'ColumnChart',dataTable:data,options:{'title':'Attribute scores','width':'1200','height':'600','is3d':'true','backgroundColor':'transparent','backgroundColor.stroke':'white','hAxis':{"title":"Attributes"},'vAxis':{"title":"Score by attribute"}},containerId:'google-attribute-scores'});wrapper.draw();}
function editor_init(data){editor_wrapper=new google.visualization.ChartWrapper({dataTable:data,containerId:'google-editor-scores',chartType:'LineChart',options:{'title':'Custom chart','width':'800','height':'1000','is3d':'true','backgroundColor':'transparent','backgroundColor.stroke':'white','chartArea.left':'10','chartArea.top':'10'}});editor_wrapper.draw();}
function openEditor(){var editor=new google.visualization.ChartEditor();google.visualization.events.addListener(editor,'ok',function(){attribute_scores_wrapper=editor.getChartWrapper();attribute_scores_wrapper.draw(document.getElementById('google-attribute-scores'));});editor.openDialog(attribute_scores_wrapper);}
function init_select(){var select_content="<option name=\"default\" value=\"default\">Please select an attribute</option>";for(var index in scores.attribute_name){select_content+="<option name=\""+index+"\" value=\""+index+"\">"+scores.attribute_name[index].name+"</option>";}
$("select.attribute-select").html(select_content);}
function change_attribute(){var select_attr_id=$(this).val();if(select_attr_id!="default"){var select_attr_name=scores.attribute_name[select_attr_id].name;var col_index;for(var i=2;i<mainDataset.getNumberOfColumns();i++){if(mainDataset.getColumnLabel(i)==select_attr_name){col_index=i;break;}}
attributeScoresDataset.sort([{column:col_index,desc:true}]);dataset=new google.visualization.DataView(attributeScoresDataset);dataset.setColumns([0,col_index]);render_attribute_scores(dataset);}
else{$("div#google-attribute-scores").html("<span>Select an attribute first.</span>");}}
function results_per_page(){/*console.log($(this).val());*/render_tabular_scores(mainDataset);}
function toggleHeader(){var toToggle="undefined";toToggle=$(this).attr("name");$("div#comparison-results").find(toToggle.toString()).toggle("fast");}
$(function(){init_select();$("h1.tabHeader").live('click',toggleHeader);$("select.tabular-max-per-page").live('change',results_per_page);$("button.editor-trigger").live('click',openEditor);$("select.attribute-select").live('change',change_attribute);$("div.entity-info-wrapper span.close").live('click',function(){$("div.entity-info-wrapper").hide("slow");});$("table.rankings-table a").live('hover',function(){render_entity_info($(this).attr("name"));});});
